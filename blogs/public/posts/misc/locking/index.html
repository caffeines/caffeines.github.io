<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/blogs/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blogs/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Understanding Locking: Pessimistic and Optimistic Approaches | Caffeines</title>
<meta name="keywords" content="Locking, Database">
<meta name="description" content="Two primary approaches to locking are pessimistic and optimistic locking">
<meta name="author" content="Sadat Sayem">
<link rel="canonical" href="http://localhost:1313/blogs/posts/misc/locking/">
<link crossorigin="anonymous" href="http://localhost:1313/blogs/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/blogs/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/blogs/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/blogs/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/blogs/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/blogs/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blogs/posts/misc/locking/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/blogs/posts/misc/locking/">
  <meta property="og:site_name" content="Caffeines">
  <meta property="og:title" content="Understanding Locking: Pessimistic and Optimistic Approaches">
  <meta property="og:description" content="Two primary approaches to locking are pessimistic and optimistic locking">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-03-11T00:00:00+00:00">
    <meta property="article:tag" content="Locking">
    <meta property="article:tag" content="Database">
    <meta property="og:image" content="http://localhost:1313/blogs/images/locking.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/blogs/images/locking.png">
<meta name="twitter:title" content="Understanding Locking: Pessimistic and Optimistic Approaches">
<meta name="twitter:description" content="Two primary approaches to locking are pessimistic and optimistic locking">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/blogs/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Understanding Locking: Pessimistic and Optimistic Approaches",
      "item": "http://localhost:1313/blogs/posts/misc/locking/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Understanding Locking: Pessimistic and Optimistic Approaches",
  "name": "Understanding Locking: Pessimistic and Optimistic Approaches",
  "description": "Two primary approaches to locking are pessimistic and optimistic locking",
  "keywords": [
    "Locking", "Database"
  ],
  "articleBody": "In the world of concurrent programming and database management, locking mechanisms are crucial to ensure data consistency and integrity. Two primary approaches to locking are pessimistic and optimistic locking. Each has its own use cases, advantages, and disadvantages. In this blog post we will understand of these two approaches, along with the real-world examples and an introduction to the Compare-and-Swap (CAS) mechanism.\nPessimistic Locking Pessimistic locking is a strategy where a resource is locked as soon as a transaction starts and remains locked until the transaction is completed. It has been called “pessimistic” because of the assumption that conflicts between concurrent transactions do occur frequently.\nHow It Works Lock Acquisition: If a transaction needs to read or write to certain resources, then it first acquires a lock on those resources. Exclusive access: No other transaction can access the resource under lock until it is released. Lock Release: The lock is released when the transaction is complete, whether through commit or rollback. Real-World Example Let’s think about a banking system where users can transfer their money form accounts. If two users try to transfer money from the same account simultaneously, it could lead to inconsistencies. In this situation the pessimistic locking plays the vital role to save from inconsistencies.\nBEGIN TRANSACTION; SELECT balance FROM accounts WHERE account_id = 12345 FOR UPDATE; -- Perform transfer operations UPDATE accounts SET balance = balance - 100 WHERE account_id = 12345; COMMIT; In this example, the FOR UPDATE clause locks the account record, preventing other transactions from modifying it until the current transaction is complete.\nAdvantages Data Integrity: Ensures that no other transaction can modify the resource while it is being processed, thus maintaining data integrity. Simplicity: Easier to implement and understand, especially in systems where conflicts are frequent. Disadvantages Performance Overhead: Can lead to significant performance bottlenecks, especially in high-concurrency environments. Deadlocks: Increased risk of deadlocks, where two or more transactions are waiting indefinitely for each other to release locks. Optimistic Locking On the other hand, Optimistic locking use to minimize conflicts that can occur when multiple transactions try to access and modify the same data simultaneously. It’s based on the assumption that conflicts are rare, and therefore, it avoids the overhead of pessimistic locking, which involves acquiring exclusive locks on data before accessing it.\nHow It Works Read: A transaction reads the data it needs to modify. Version: A version stamp or timestamp is associated with the data to track its state. Update: The transaction modifies the data as needed. Write: When the transaction is ready to commit, it checks the current version stamp of the data against the version stamp it read at the beginning. Conflict Detection: If the version stamps match, the transaction can commit the changes. If they don’t match, it means that the data has been modified by another transaction since the original read, and a conflict has occurred. Conflict Resolution: In case of a conflict, the transaction can read the data again and retry the update or it can abort the transaction and inform the user about the conflict. Real-World Example Consider an e-commerce platform where multiple users can update product inventory. With optimistic locking, each product record has a version number. When a user updates the inventory, the system checks the version number before committing:\nBEGIN TRANSACTION; SELECT version, stock FROM products WHERE product_id = 98765; -- Perform inventory update UPDATE products SET stock = stock - 1, version = version + 1 WHERE product_id = 98765 AND version = 1; COMMIT; If the version number has changed since the initial read, the update fails, and the transaction is retried.\nAdvantages Performance: Better performance in high-concurrency environments as it reduces the time resources are locked. Scalability: More scalable as it allows multiple transactions to proceed without waiting for locks. Implementation: It’s generally easier to implement than pessimistic locking. Disadvantages Complexity: More complex to implement and manage, especially in systems with frequent conflicts. Retry Overhead: Transactions may need to be retried multiple times, leading to increased overhead. Compare-and-Swap (CAS) Mechanism Compare-and-Swap (CAS) is a hardware-level atomic instruction used for efficient synchronization in multi-threaded programming to avoid locking algorithm.\nHow It Works Read: The CAS operation reads the current value of a variable. Compare: It compares the read value with an expected value that provided. Swap: If the read value matches the expected value, the CAS instruction atomically updates with the new value. If the values don’t match, the CAS instruction fails without modifying. Real-World Example In Go, CAS can be implemented using the sync/atomic package.\npackage main import ( \"fmt\" \"sync\" \"sync/atomic\" ) func main() { var counter atomic.Int32 counter.Store(0) wg := sync.WaitGroup{} wg.Add(100) increment := func() { oldValue, newValue := counter.Load(), counter.Load()+1 swapped := counter.CompareAndSwap(oldValue, newValue) if !swapped { fmt.Println(\"Failed to swap\") } wg.Done() } for i := 0; i \u003c 100; i++ { go increment() } wg.Wait() fmt.Println(counter.Load()) } In this example, CompareAndSwap ensures that the increment operation is performed atomically.\nAdvantages of CAS Higher Performance: CAS is non-blocking by nature operation, which lead to better performance in high concurrent situation. Lower Overhead: CAS doesn’t require the overhead of context switch and thread scheduling, which can be significant to some extent. Disadvantages of CAS Complexity: CAS implementation can be more complex than traditional locking, and it’s true when it comes to understanding the implementation in some cases. Potential for Busy Waiting: If CAS operations fail frequently, it can lead to busy waiting, where threads continuously retry the operation until they succeed. Choosing the Right Approach The choice between pessimistic locking, optimistic locking, and CAS depends on the specific requirements and characteristics of your system:\nHigh Conflict: If your system experiences high contention for resources, pessimistic locking may be more suitable to ensure data integrity. Low Contention: In systems with low contention, optimistic locking can provide better performance and scalability. Complexity vs. Performance: Consider the trade-off between implementation complexity and performance. Pessimistic locking is simpler but may lead to performance bottlenecks, while optimistic locking and CAS are more complex but can offer better performance in the right scenarios. ",
  "wordCount" : "1011",
  "inLanguage": "en",
  "image":"http://localhost:1313/blogs/images/locking.png","datePublished": "2024-03-11T00:00:00Z",
  "dateModified": "2024-03-11T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Sadat Sayem"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blogs/posts/misc/locking/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Caffeines",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/blogs/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/blogs/" accesskey="h" title="Caffeines (Alt + H)">Caffeines</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blogs/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blogs/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blogs/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sadat.me" title="About Me">
                    <span>About Me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/blogs/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blogs/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Understanding Locking: Pessimistic and Optimistic Approaches
    </h1>
    <div class="post-description">
      Two primary approaches to locking are pessimistic and optimistic locking
    </div>
    <div class="post-meta"><span title='2024-03-11 00:00:00 +0000 UTC'>March 11, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Sadat Sayem&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/misc/locking.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>

</div>
  </header> 
<figure class="entry-cover">
            <img loading="eager"
                srcset='http://localhost:1313/blogs/images/locking_hu_51f06a309a2fc962.png 360w,http://localhost:1313/blogs/images/locking_hu_34cbcbad9e18092e.png 480w,http://localhost:1313/blogs/images/locking_hu_3b128afda0e7114e.png 720w,http://localhost:1313/blogs/images/locking_hu_ac2302e3aad48c4f.png 1080w,http://localhost:1313/blogs/images/locking_hu_a0c1c74ad3f75ae4.png 1500w,http://localhost:1313/blogs/images/locking.png 1640w'
                src="http://localhost:1313/blogs/images/locking.png"
                sizes="(min-width: 768px) 720px, 100vw"
                width="1640" height="924"
                alt="Locking">
        <figcaption>Locking</figcaption>
</figure><div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#pessimistic-locking" aria-label="Pessimistic Locking">Pessimistic Locking</a><ul>
                        
                <li>
                    <a href="#how-it-works" aria-label="How It Works">How It Works</a></li>
                <li>
                    <a href="#real-world-example" aria-label="Real-World Example">Real-World Example</a></li>
                <li>
                    <a href="#advantages" aria-label="Advantages">Advantages</a></li>
                <li>
                    <a href="#disadvantages" aria-label="Disadvantages">Disadvantages</a></li></ul>
                </li>
                <li>
                    <a href="#optimistic-locking" aria-label="Optimistic Locking">Optimistic Locking</a><ul>
                        
                <li>
                    <a href="#how-it-works-1" aria-label="How It Works">How It Works</a></li>
                <li>
                    <a href="#real-world-example-1" aria-label="Real-World Example">Real-World Example</a></li>
                <li>
                    <a href="#advantages-1" aria-label="Advantages">Advantages</a></li>
                <li>
                    <a href="#disadvantages-1" aria-label="Disadvantages">Disadvantages</a></li></ul>
                </li>
                <li>
                    <a href="#compare-and-swap-cas-mechanism" aria-label="Compare-and-Swap (CAS) Mechanism">Compare-and-Swap (CAS) Mechanism</a><ul>
                        
                <li>
                    <a href="#how-it-works-2" aria-label="How It Works">How It Works</a></li>
                <li>
                    <a href="#real-world-example-2" aria-label="Real-World Example">Real-World Example</a></li>
                <li>
                    <a href="#advantages-of-cas" aria-label="Advantages of CAS">Advantages of CAS</a></li>
                <li>
                    <a href="#disadvantages-of-cas" aria-label="Disadvantages of CAS">Disadvantages of CAS</a></li></ul>
                </li>
                <li>
                    <a href="#choosing-the-right-approach" aria-label="Choosing the Right Approach">Choosing the Right Approach</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>In the world of concurrent programming and database management, locking mechanisms are crucial to ensure data consistency and integrity. Two primary approaches to locking are pessimistic and optimistic locking. Each has its own use cases, advantages, and disadvantages. In this blog post we will understand of these two approaches, along with the real-world examples and an introduction to the Compare-and-Swap (CAS) mechanism.</p>
<h2 id="pessimistic-locking">Pessimistic Locking<a hidden class="anchor" aria-hidden="true" href="#pessimistic-locking">#</a></h2>
<p>Pessimistic locking is a strategy where a resource is locked as soon as a transaction starts and remains locked until the transaction is completed. It has been called “pessimistic” because of the assumption that conflicts between concurrent transactions do occur frequently.</p>
<h3 id="how-it-works">How It Works<a hidden class="anchor" aria-hidden="true" href="#how-it-works">#</a></h3>
<ul>
<li><strong>Lock Acquisition:</strong> If a transaction needs to read or write to certain resources, then it first acquires a lock on those resources.</li>
<li><strong>Exclusive access:</strong> No other transaction can access the resource under lock until it is released.</li>
<li><strong>Lock Release:</strong> The lock is released when the transaction is complete, whether through commit or rollback.</li>
</ul>
<h3 id="real-world-example">Real-World Example<a hidden class="anchor" aria-hidden="true" href="#real-world-example">#</a></h3>
<p>Let’s think about a banking system where users can transfer their money form accounts. If two users try to transfer money from the same account simultaneously, it could lead to inconsistencies. In this situation the pessimistic locking plays the vital role to save from inconsistencies.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">BEGIN</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12345</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Perform transfer operations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">account_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12345</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COMMIT</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>In this example, the <code>FOR UPDATE</code> clause locks the account record, preventing other transactions from modifying it until the current transaction is complete.</p>
<h3 id="advantages">Advantages<a hidden class="anchor" aria-hidden="true" href="#advantages">#</a></h3>
<ul>
<li><strong>Data Integrity:</strong> Ensures that no other transaction can modify the resource while it is being processed, thus maintaining data integrity.</li>
<li><strong>Simplicity:</strong> Easier to implement and understand, especially in systems where conflicts are frequent.</li>
</ul>
<h3 id="disadvantages">Disadvantages<a hidden class="anchor" aria-hidden="true" href="#disadvantages">#</a></h3>
<ul>
<li><strong>Performance Overhead:</strong> Can lead to significant performance bottlenecks, especially in high-concurrency environments.</li>
<li><strong>Deadlocks:</strong> Increased risk of deadlocks, where two or more transactions are waiting indefinitely for each other to release locks.</li>
</ul>
<hr>
<h2 id="optimistic-locking">Optimistic Locking<a hidden class="anchor" aria-hidden="true" href="#optimistic-locking">#</a></h2>
<p>On the other hand, Optimistic locking use to minimize conflicts that can occur when multiple transactions try to access and modify the same data simultaneously. It’s based on the assumption that conflicts are rare, and therefore, it avoids the overhead of pessimistic locking, which involves acquiring exclusive locks on data before accessing it.</p>
<h3 id="how-it-works-1">How It Works<a hidden class="anchor" aria-hidden="true" href="#how-it-works-1">#</a></h3>
<ul>
<li><strong>Read:</strong> A transaction reads the data it needs to modify.</li>
<li><strong>Version:</strong> A version stamp or timestamp is associated with the data to track its state.</li>
<li><strong>Update:</strong> The transaction modifies the data as needed.</li>
<li><strong>Write:</strong> When the transaction is ready to commit, it checks the current version stamp of the data against the version stamp it read at the beginning.</li>
<li><strong>Conflict Detection:</strong> If the version stamps match, the transaction can commit the changes. If they don’t match, it means that the data has been modified by another transaction since the original read, and a conflict has occurred.</li>
<li><strong>Conflict Resolution:</strong> In case of a conflict, the transaction can read the data again and <strong>retry</strong> the update or it can <strong>abort</strong> the transaction and inform the user about the conflict.</li>
</ul>
<h3 id="real-world-example-1">Real-World Example<a hidden class="anchor" aria-hidden="true" href="#real-world-example-1">#</a></h3>
<p>Consider an e-commerce platform where multiple users can update product inventory. With optimistic locking, each product record has a version number. When a user updates the inventory, the system checks the version number before committing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">BEGIN</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">version</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">98765</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Perform inventory update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">98765</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">COMMIT</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>If the version number has changed since the initial read, the update fails, and the transaction is retried.</p>
<h3 id="advantages-1">Advantages<a hidden class="anchor" aria-hidden="true" href="#advantages-1">#</a></h3>
<ul>
<li><strong>Performance:</strong> Better performance in high-concurrency environments as it reduces the time resources are locked.</li>
<li><strong>Scalability:</strong> More scalable as it allows multiple transactions to proceed without waiting for locks.</li>
<li><strong>Implementation:</strong> It’s generally easier to implement than pessimistic locking.</li>
</ul>
<h3 id="disadvantages-1">Disadvantages<a hidden class="anchor" aria-hidden="true" href="#disadvantages-1">#</a></h3>
<ul>
<li><strong>Complexity:</strong> More complex to implement and manage, especially in systems with frequent conflicts.</li>
<li><strong>Retry Overhead:</strong> Transactions may need to be retried multiple times, leading to increased overhead.</li>
</ul>
<hr>
<h2 id="compare-and-swap-cas-mechanism">Compare-and-Swap (CAS) Mechanism<a hidden class="anchor" aria-hidden="true" href="#compare-and-swap-cas-mechanism">#</a></h2>
<p>Compare-and-Swap (CAS) is a hardware-level atomic instruction used for efficient synchronization in multi-threaded programming to avoid locking algorithm.</p>
<h3 id="how-it-works-2">How It Works<a hidden class="anchor" aria-hidden="true" href="#how-it-works-2">#</a></h3>
<ul>
<li><strong>Read:</strong> The CAS operation reads the current value of a variable.</li>
<li><strong>Compare:</strong> It compares the read value with an expected value that provided.</li>
<li><strong>Swap:</strong> If the read value matches the expected value, the CAS instruction atomically updates with the new value. If the values don’t match, the CAS instruction fails without modifying.</li>
</ul>
<h3 id="real-world-example-2">Real-World Example<a hidden class="anchor" aria-hidden="true" href="#real-world-example-2">#</a></h3>
<p>In Go, CAS can be implemented using the <code>sync/atomic</code> package.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync/atomic&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">counter</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">counter</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span> <span class="o">:=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">increment</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldValue</span><span class="p">,</span> <span class="nx">newValue</span> <span class="o">:=</span> <span class="nx">counter</span><span class="p">.</span><span class="nf">Load</span><span class="p">(),</span> <span class="nx">counter</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nx">swapped</span> <span class="o">:=</span> <span class="nx">counter</span><span class="p">.</span><span class="nf">CompareAndSwap</span><span class="p">(</span><span class="nx">oldValue</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">swapped</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed to swap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nf">increment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">counter</span><span class="p">.</span><span class="nf">Load</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In this example, <code>CompareAndSwap</code> ensures that the increment operation is performed atomically.</p>
<h3 id="advantages-of-cas">Advantages of CAS<a hidden class="anchor" aria-hidden="true" href="#advantages-of-cas">#</a></h3>
<ul>
<li><strong>Higher Performance:</strong> CAS is non-blocking by nature operation, which lead to better performance in high concurrent situation.</li>
<li><strong>Lower Overhead:</strong> CAS doesn’t require the overhead of context switch and thread scheduling, which can be significant to some extent.</li>
</ul>
<h3 id="disadvantages-of-cas">Disadvantages of CAS<a hidden class="anchor" aria-hidden="true" href="#disadvantages-of-cas">#</a></h3>
<ul>
<li><strong>Complexity:</strong> CAS implementation can be more complex than traditional locking, and it’s true when it comes to understanding the implementation in some cases.</li>
<li><strong>Potential for Busy Waiting:</strong> If CAS operations fail frequently, it can lead to busy waiting, where threads continuously retry the operation until they succeed.</li>
</ul>
<hr>
<h2 id="choosing-the-right-approach">Choosing the Right Approach<a hidden class="anchor" aria-hidden="true" href="#choosing-the-right-approach">#</a></h2>
<p>The choice between pessimistic locking, optimistic locking, and CAS depends on the specific requirements and characteristics of your system:</p>
<ul>
<li><strong>High Conflict:</strong> If your system experiences high contention for resources, pessimistic locking may be more suitable to ensure data integrity.</li>
<li><strong>Low Contention:</strong> In systems with low contention, optimistic locking can provide better performance and scalability.</li>
<li><strong>Complexity vs. Performance:</strong> Consider the trade-off between implementation complexity and performance. Pessimistic locking is simpler but may lead to performance bottlenecks, while optimistic locking and CAS are more complex but can offer better performance in the right scenarios.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/blogs/tags/locking/">Locking</a></li>
      <li><a href="http://localhost:1313/blogs/tags/database/">Database</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blogs/posts/encryption/whatsapp/">
    <span class="title">« Prev</span>
    <br>
    <span>WhatsApp এর এনক্রিপশন প্রসেস</span>
  </a>
  <a class="next" href="http://localhost:1313/blogs/posts/git/worktree/">
    <span class="title">Next »</span>
    <br>
    <span>Git Worktrees</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on x"
            href="https://x.com/intent/tweet/?text=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f&amp;hashtags=Locking%2cDatabase">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f&amp;title=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches&amp;summary=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches&amp;source=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f&title=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on whatsapp"
            href="https://api.whatsapp.com/send?text=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches%20-%20http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on telegram"
            href="https://telegram.me/share/url?text=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Understanding Locking: Pessimistic and Optimistic Approaches on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Understanding%20Locking%3a%20Pessimistic%20and%20Optimistic%20Approaches&u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fposts%2fmisc%2flocking%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/blogs/">Caffeines</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
